<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Deal Selection Tools</title>
    <style>
        :root {
            --primary: #1a73e8; /* Blue */
            --primary-light: #e8f0fe;
            --primary-dark: #1565c0;
            --secondary: #34A853; /* Green (e.g., for exclusive star, or rotator compute) */
            --secondary-dark: #218838; /* Darker green for hover */
            --surface: #ffffff;
            --background: #f8f9fa;
            --text: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --border-light: #e0e0e0;
            --shadow-1: 0 1px 3px rgba(60,64,67,0.15), 0 1px 2px rgba(60,64,67,0.1);
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --transition-fast: 0.15s ease-out;
            --danger: #dc3545;
            --danger-dark: #c82333;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: 'Roboto', 'Noto Sans', Arial, sans-serif;
            background-color: var(--background); color: var(--text);
            line-height: 1.6; padding: 1.5rem;
        }
        .container { max-width: 1000px; margin: 1rem auto; }
        .page-title { font-size: 2.2rem; font-weight: 500; text-align: center; color: var(--primary); margin-bottom: 2rem; }

        .tool-section {
            background-color: var(--surface);
            padding: 1.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-1);
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
        }
        .tool-section h2 {
            font-size: 1.5rem; font-weight: 500; color: var(--primary-dark);
            margin-bottom: 1.25rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-light);
        }

        /* Common control group styling */
        .control-group { margin-bottom: 1.25rem; }
        .control-group label {
            display: block; font-size: 0.95rem; font-weight: 500; color: var(--text);
            margin-bottom: 0.5rem;
        }
        .control-group select, textarea#deals-input {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border);
            border-radius: var(--border-radius-sm); font-family: inherit; font-size: 0.9rem;
            background-color: var(--surface);
        }
        .control-group select:focus, textarea#deals-input:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light);
        }
        textarea#deals-input { height: 200px; resize: vertical; margin-bottom: 1rem; font-family: 'Roboto Mono', monospace; }


        .actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; background: var(--primary); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: var(--border-radius-sm); font-family: inherit; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); text-decoration: none; }
        .btn:hover { background: var(--primary-dark); box-shadow: var(--shadow-1); }
        
        .btn-secondary { background: var(--surface); color: var(--primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--primary-light); border-color: var(--primary); }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        
        .btn-compute { /* Specific style for main compute buttons if needed, e.g. rotator */
            background: var(--secondary); width: 100%; padding: 0.75em; font-size: 1em;
        }
        .btn-compute:hover { background: var(--secondary-dark); }


        /* Filter bubbles (reused from App 2) */
        #filters-and-sorts-container h2, /* Target h2 within deal lister's filter section */
        .control-section h2 { /* Also target this if used elsewhere */
            font-size: 1rem; font-weight: 500; color: var(--text);
            margin-bottom: 0.75rem; padding-bottom: 0.35rem; border-bottom: 1px solid var(--border-light);
        }
        .filter-bubbles { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .filter-bubbles button, .options-controls button {
            background: var(--surface); color: var(--primary); border: 1px solid var(--border);
            padding: 0.4rem 0.8rem; border-radius: 16px; font-family: inherit;
            font-size: 0.85rem; cursor: pointer; transition: all var(--transition-fast);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; /* Prevent overly wide bubbles */
        }
        .filter-bubbles button:hover, .options-controls button:hover {
            background: var(--primary-light); border-color: var(--primary); transform: translateY(-1px);
        }
        .filter-bubbles button.active, .options-controls button.active {
            background: var(--primary); color: white; border-color: var(--primary); font-weight: 500;
        }
        .filter-bubbles button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            border-color: #ced4da;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .filter-bubbles button:disabled:hover {
            transform: none;
        }
        
        /* For rotator output and deal lister output consistency */
        .output-area {
            margin-top: 1.5em; padding: 1em; background: #f9f9f9;
            border: 1px solid var(--border-light); border-radius: var(--border-radius-sm);
            min-height: 50px; font-size: 0.95rem;
        }
        .output-area strong { color: var(--primary-dark); }

        /* Deal Lister specific styles from App 2 */
        #filters-and-sorts-container {
            padding: 1rem 0; 
            margin-bottom: 1.5rem;
        }
        .control-section { margin-bottom: 1.25rem; }
        .control-section:last-child { margin-bottom: 0; }
        
        .options-controls { display: flex; gap: 0.75rem; align-items: center; }
        .sort-options { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .sort-options button { font-size: 0.85rem; padding: 0.4rem 0.8rem; border-radius: var(--border-radius-sm); }
        .sort-options button.active {
            background: var(--primary-dark); color: white; border-color: var(--primary-dark); font-weight: 500;
        }

        #deal-list-container { margin-top: 1rem; border: 1px solid var(--border-light); border-radius: var(--border-radius-md); padding: 0.5rem 0; }
        #deal-list { list-style: none; max-height: 70vh; overflow-y: auto; padding: 0 0.5rem 0 1.5rem; /* Adjusted padding for remove button space */ }
        .deal-item {
            border-bottom: 1px solid var(--border-light); padding: 1rem 0;
            display: grid; 
            grid-template-columns: auto 1fr auto; /* indicator | content | remove_button */
            gap: 0 1rem; align-items: start;
         }
        .deal-item:last-child { border-bottom: none; }
        .deal-item .indicator { grid-column: 1; grid-row: 1 / 3; font-size: 1.5rem; padding-top: 0.1em; }
        .deal-item .indicator .exclusive-star { color: var(--secondary); }
        .deal-item .supplier { font-weight: 500; font-size: 1.1rem; color: var(--primary-dark); grid-column: 2; margin-bottom: 0.25rem; }
        .deal-item .title-line { grid-column: 2; display: flex; align-items: baseline; flex-wrap: wrap; margin-bottom: 0.3rem; }
        .deal-item .title { font-weight: 500; margin-right: 0.75rem; font-size: 1rem; }
        .deal-item .expiry-pill {
            font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); background-color: #e8eaed;
            padding: 0.1rem 0.6rem; border-radius: 10px; white-space: nowrap; border: 1px solid var(--border-light);
        }
        .deal-item .description { grid-column: 2; font-size: 0.9rem; color: var(--text-secondary); }
        .placeholder { padding: 2rem; text-align: center; color: var(--text-secondary); }

        .deal-item .remove-deal-btn {
            grid-column: 3; 
            grid-row: 1 / span 3; 
            align-self: center;
            justify-self: center;
            background: transparent;
            border: none;
            color: var(--danger);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: color var(--transition-fast);
        }
        .deal-item .remove-deal-btn:hover {
            color: var(--danger-dark);
            font-weight: bold;
        }
        #rotator-filter-status-container {
            background-color: var(--primary-light); 
            padding: 0.75rem 1.5rem; 
            margin-bottom: 1rem;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--primary);
        }
        #rotator-filter-status-container p {
            margin:0; font-weight: 500; color: var(--primary-dark);
            display: flex; justify-content: space-between; align-items: center;
        }
        #rotator-filter-names { font-weight: normal; color: var(--text); }

    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">Travel Deal Selection Tools</h1>

        <!-- Section 1: Weekly Hot Deals Supplier Rotator -->
        <section id="rotator-section" class="tool-section">
            <h2>Weekly Hot Deals Supplier Rotator</h2>
            
            <div class="control-group">
                <label for="featured-brand-select">Select This Weekâ€™s Main Feature Brand:</label>
                <select id="featured-brand-select">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div class="control-group">
                <label>Select Last Weekâ€™s Below-the-Fold Brands (up to 4):</label>
                <div id="lastweek-brands-bubbles" class="filter-bubbles">
                    <!-- Bubbles populated by JS -->
                </div>
            </div>

            <button id="compute-rotator-btn" class="btn btn-compute">Compute This Weekâ€™s Below-the-Fold</button>
            
            <div id="rotator-output" class="output-area">
                <p style="color: var(--text-secondary);">Select brands above and click compute.</p>
            </div>
        </section>

        <!-- Separator -->
        <hr style="margin: 2.5rem 0; border: none; border-top: 1px solid var(--border-light);">

        <!-- Section 2: Enhanced JSON Deal Lister -->
        <section id="deal-lister-section" class="tool-section">
            <h2>Enhanced JSON Deal Lister</h2>
            
            <textarea id="deals-input" placeholder="Paste the JSON array of deal objects here..."></textarea>
            
            <div class="actions-bar">
                <button class="btn" onclick="processJsonInput()">Show Deals</button>
                <button id="copy-selected-deals-btn" class="btn btn-secondary" onclick="copySelectedDealsToClipboard()">Copy Selected Deals (New Format)</button>
                <button class="btn btn-secondary" onclick="clearAllDealLister()">Clear Deal Lister</button>
            </div>

            <div id="rotator-filter-status-container" style="display: none;">
                <p>
                    <span>Filtering by Rotator Suppliers: <strong id="rotator-filter-names"></strong></span>
                    <button onclick="clearRotatorFilterAndRefreshDeals()" class="btn btn-secondary btn-sm">Clear Rotator Filter</button>
                </p>
            </div>

            <div id="filters-and-sorts-container" style="display: none;">
                <div class="control-section">
                    <h2>Filter by Supplier:</h2>
                    <div id="supplier-filters" class="filter-bubbles"></div>
                </div>
                <div class="control-section">
                    <h2>Options:</h2>
                    <div class="options-controls">
                        <button id="exclusive-toggle-btn" onclick="toggleExclusiveFilter()">Show Only Exclusives</button>
                    </div>
                </div>
                <div class="control-section">
                    <h2>Sort by:</h2>
                    <div class="sort-options">
                        <button id="sort-supplier" class="btn btn-secondary active" onclick="setSort('supplier')">Supplier</button>
                        <button id="sort-expiry" class="btn btn-secondary" onclick="setSort('expiry')">Expiry Date</button>
                        <button id="sort-exclusive" class="btn btn-secondary" onclick="setSort('exclusive')">Exclusives First</button>
                    </div>
                </div>
            </div>

            <div id="deal-list-container">
                <ul id="deal-list">
                    <li class="placeholder">Paste JSON and click "Show Deals"</li>
                </ul>
            </div>
        </section>
    </div>

    <script>
    (function() {
        // --- COMMON DATA FOR ROTATOR ---
        const potm = ['MSC Cruises', 'AmaWaterways'];
        const mostPriority = ['Norwegian Cruise Line', 'Royal Caribbean'];
        const midPriority = ['Celebrity Cruises', 'Disney Cruise Line', 'Virgin Voyages', 'Holland America Line', 'Princess Cruises'];
        const leastPriority = ['Carnival Cruise Line', 'MSC Cruises'];

        const rotatorBrandDisplayList = [
            { text: "Norwegian", value: "Norwegian Cruise Line" }, { text: "Royal Caribbean", value: "Royal Caribbean" },
            { text: "Celebrity", value: "Celebrity Cruises" }, { text: "Disney Cruise Line", value: "Disney Cruise Line" },
            { text: "Virgin Voyages", value: "Virgin Voyages" }, { text: "Holland America", value: "Holland America Line" },
            { text: "Princess", value: "Princess Cruises" }, { text: "Carnival", value: "Carnival Cruise Line" },
            { text: "MSC", value: "MSC Cruises" }, { text: "Costa", value: "Costa Cruises" },
            { text: "Viking Ocean", value: "Viking Ocean Cruises" }, { text: "Seabourn", value: "Seabourn" },
            { text: "Regent Seven Seas", value: "Regent Seven Seas Cruises" }, { text: "Oceania", value: "Oceania Cruises" },
            { text: "Silversea", value: "Silversea" }, { text: "Explora Journeys", value: "Explora Journeys" },
            { text: "Azamara", value: "Azamara" }, { text: "Scenic Eclipse", value: "Scenic Eclipse" },
            { text: "Atlas Ocean Voyages", value: "Atlas Ocean Voyages" }, { text: "Crystal Cruises", value: "Crystal Cruises" },
            { text: "Emerald Cruises", value: "Emerald Cruises" }, { text: "Cunard", value: "Cunard" },
            { text: "Windstar", value: "Windstar Cruises" }, { text: "Paul Gauguin", value: "Paul Gauguin Cruises" },
            { text: "Ponant", value: "Ponant" }, { text: "American Cruise Line", value: "American Cruise Line" },
            { text: "Tauck Cruises", value: "Tauck Cruises" }, { text: "Star Clippers", value: "Star Clippers" },
            { text: "Four Seasons Yachts", value: "Four Seasons Yachts" }, { text: "Ritz-Carlton Yacht", value: "Ritz-Carlton Yacht Collection" },
            { text: "Viking River", value: "Viking River Cruises" }, { text: "Avalon Waterways", value: "Avalon Waterways" },
            { text: "AmaWaterways", value: "AmaWaterways" }, { text: "CroisiEurope", value: "CroisiEurope" },
            { text: "Riverside Cruises", value: "Riverside Cruises" }, { text: "Scenic River", value: "Scenic River Cruises" },
            { text: "Riviera River", value: "Riviera River Cruises" }, { text: "Uniworld", value: "Uniworld Boutique River Cruises" },
            { text: "Lindblad", value: "Lindblad Expeditions" }, { text: "Hurtigruten", value: "Hurtigruten" },
            { text: "UnCruise Adventures", value: "UnCruise Adventures" },
            { text: "Disney Cruises", value: "Disney Cruises" }, 
            { text: "DisneyWorld", value: "DisneyWorld" }, { text: "Disneyland", value: "Disneyland" },
            { text: "Aulani", value: "Aulani" }, { text: "Adventures by Disney", value: "Adventures by Disney" },
            { text: "Sandals", value: "Sandals" }, { text: "Beaches Resorts", value: "Beaches Resorts" },
            { text: "Breathless Resorts", value: "Breathless Resorts" }, { text: "Club Med", value: "Club Med" },
            { text: "El Dorado Spa Resorts", value: "El Dorado Spa Resorts" }, { text: "Excellence Resorts", value: "Excellence Resorts" },
            { text: "Hard Rock Hotels", value: "Hard Rock Hotels" }, { text: "Iberostar", value: "Iberostar Hotels & Resorts" },
            { text: "Dreams Resorts", value: "Dreams Resorts" }, { text: "Karisma Hotels", value: "Karisma Hotels & Resorts" },
            { text: "Villas of Distinction", value: "Villas of Distinction" }, { text: "Palace Resorts", value: "Palace Resorts" },
            { text: "Atlantis Paradise Island", value: "Atlantis Paradise Island" }, { text: "Melia", value: "Melia Hotels" },
            { text: "RIU Hotels & Resorts", value: "RIU Hotels & Resorts" }, { text: "Outrigger", value: "Outrigger Hotels & Resorts" },
            { text: "ZoÃ«try", value: "ZoÃ«try Wellness & Spa Resorts" }, { text: "Secrets Resorts", value: "Secrets Resorts" },
            { text: "American Airlines Vacations", value: "American Airlines Vacations" }, { text: "Delta Vacations", value: "Delta Vacations" },
            { text: "Southwest Vacations", value: "Southwest Vacations" }, { text: "United Vacations", value: "United Vacations" },
            { text: "Great Safaris", value: "Great Safaris" }, { text: "African Travel", value: "African Travel" },
            { text: "Abercrombie & Kent", value: "Abercrombie & Kent" }, { text: "G Adventures", value: "G Adventures" },
            { text: "Globus Journeys", value: "Globus Journeys" }, { text: "Rocky Mountaineer", value: "Rocky Mountaineer" },
            { text: "Collette", value: "Collette" }, { text: "CIE Tours", value: "CIE Tours" },
            { text: "Trafalgar", value: "Trafalgar" }
        ].sort((a, b) => a.text.localeCompare(b.text));


        // --- ROTATOR FUNCTIONALITY ---
        const featuredBrandSelect = document.getElementById('featured-brand-select');
        const lastweekBrandsContainer = document.getElementById('lastweek-brands-bubbles');
        const computeRotatorBtn = document.getElementById('compute-rotator-btn');
        const rotatorOutputDiv = document.getElementById('rotator-output');
        let selectedLastWeekBrands = []; 
        let rotatorComputedSuppliers = []; 

        function populateRotatorSelectors() {
            featuredBrandSelect.innerHTML = '<option value="">-- Select Main Feature Brand --</option>';
            rotatorBrandDisplayList.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.value;
                option.textContent = brand.value; 
                featuredBrandSelect.appendChild(option);
            });

            lastweekBrandsContainer.innerHTML = '';
            rotatorBrandDisplayList.forEach(brand => {
                const button = document.createElement('button');
                button.dataset.brandValue = brand.value;
                button.textContent = brand.text; 
                button.title = brand.value; 
                button.onclick = () => toggleLastWeekBrand(button, brand.value);
                lastweekBrandsContainer.appendChild(button);
            });
        }

        function toggleLastWeekBrand(buttonEl, brandValue) {
            if (selectedLastWeekBrands.includes(brandValue)) {
                selectedLastWeekBrands = selectedLastWeekBrands.filter(b => b !== brandValue);
                buttonEl.classList.remove('active');
            } else {
                if (selectedLastWeekBrands.length < 4) {
                    selectedLastWeekBrands.push(brandValue);
                    buttonEl.classList.add('active');
                } else {
                    alert('You can select up to 4 last week brands.');
                }
            }
        }

        function computeRotatorResults() {
            const featured = featuredBrandSelect.value;
            
            if (!featured) {
                rotatorOutputDiv.innerHTML = '<p style="color: var(--text-secondary);">Please select This Weekâ€™s Main Feature Brand.</p>';
                rotatorComputedSuppliers = [];
                clearRotatorFilterLogic(); 
                updateAndRenderDeals(); 
                return;
            }
            if (selectedLastWeekBrands.length === 0) {
                 rotatorOutputDiv.innerHTML = '<p style="color: var(--text-secondary);">Please select at least one Last Weekâ€™s Below-the-Fold Brand.</p>';
                rotatorComputedSuppliers = [];
                clearRotatorFilterLogic(); 
                updateAndRenderDeals();
                return;
            }

            let result = potm.filter(b => b !== featured && !selectedLastWeekBrands.includes(b));

            function addFromPriorityList(list) {
                for (const b of list) {
                    if (result.length >= 4) break;
                    if (b === featured) continue;
                    if (selectedLastWeekBrands.includes(b)) continue;
                    if (!result.includes(b)) result.push(b);
                }
            }

            addFromPriorityList(mostPriority);
            addFromPriorityList(midPriority);
            addFromPriorityList(leastPriority);
            
            if (result.length < 4) {
                 const allPossibleBrandsForRotator = rotatorBrandDisplayList.map(b => b.value);
                 addFromPriorityList(allPossibleBrandsForRotator); 
            }
            
            rotatorComputedSuppliers = result.slice(0, 4);

            if (rotatorComputedSuppliers.length === 0) {
                 rotatorOutputDiv.innerHTML = '<p style="color: var(--text-secondary);">No suitable below-the-fold suppliers found based on selections and priority lists.</p>';
                 clearRotatorFilterLogic();
            } else {
                rotatorOutputDiv.innerHTML = `<strong>This Weekâ€™s Below-the-Fold Suppliers:</strong><br>` +
                                          rotatorComputedSuppliers.map(b => `â€“ ${b}`).join('<br>');
                activateRotatorFilterInDealLister(rotatorComputedSuppliers);
            }
            updateAndRenderDeals(); 
        }

        // --- DEAL LISTER FUNCTIONALITY ---
        let allParsedDeals = [];
        let displayedDeals = []; 
        let selectedDealsForCopy = []; 
        let currentSort = 'supplier';
        let activeSupplierFilter = null;
        let showExclusivesOnly = false;
        let isRotatorFilterActive = false;

        const SUPPLIER_INFO = { 
             "norwegian cruise line": { name: "Norwegian Cruise Line" }, "royal caribbean": { name: "Royal Caribbean" }, "celebrity cruises": { name: "Celebrity Cruises" }, "disney cruise line": { name: "Disney Cruise Line" }, "virgin voyages": { name: "Virgin Voyages" }, "holland america line": { name: "Holland America Line" }, "princess": { name: "Princess Cruises" }, "princess cruises": { name: "Princess Cruises" }, "carnival": { name: "Carnival Cruise Line" }, "carnival cruise line": { name: "Carnival Cruise Line" }, "msc cruises": { name: "MSC Cruises" }, "viking": { name: "Viking Ocean Cruises" }, "viking ocean cruises": { name: "Viking Ocean Cruises"}, "american cruise line": { name: "American Cruise Line" }, "atlas ocean voyages": { name: "Atlas Ocean Voyages" }, "azamara": { name: "Azamara" }, "crystal cruises": { name: "Crystal Cruises" }, "cunard": { name: "Cunard" }, "emerald cruises": { name: "Emerald Cruises" }, "explora journeys": { name: "Explora Journeys" }, "four seasons yachts": { name: "Four Seasons Yachts" }, "oceania cruises": { name: "Oceania Cruises" }, "paul gauguin cruises": { name: "Paul Gauguin Cruises" }, "ponant": { name: "Ponant" }, "regent seven seas cruises": { name: "Regent Seven Seas Cruises" }, "ritz-carlton yacht collection": { name: "Ritz-Carlton Yacht Collection" }, "scenic eclipse ocean voyages": { name: "Scenic Eclipse" }, "scenic eclipse": { name: "Scenic Eclipse" }, "seabourn": { name: "Seabourn" }, "silversea": { name: "Silversea" }, "star clippers": { name: "Star Clippers" }, "tauck cruises": { name: "Tauck Cruises" }, "windstar": { name: "Windstar Cruises" }, "windstar cruises": { name: "Windstar Cruises" }, "avalon waterways": { name: "Avalon Waterways" }, "amawaterways": { name: "AmaWaterways" }, "croisieurope": { name: "CroisiEurope" }, "riverside cruises": { name: "Riverside Cruises" }, "riviera river cruises": { name: "Riviera River Cruises" }, "tauck tours": { name: "Tauck River Cruising" }, "uniworld": { name: "Uniworld Boutique River Cruises" }, "uniworld boutique river cruises": { name: "Uniworld Boutique River Cruises" }, "scenic river": { name: "Scenic River Cruises" }, "scenic luxury cruises & tours": { name: "Scenic River Cruises" }, "scenic river cruises": { name: "Scenic River Cruises" }, "lindblad expeditions & national geographic": { name: "Lindblad Expeditions" }, "lindblad expeditions": { name: "Lindblad Expeditions" }, "hurtigruten": { name: "Hurtigruten" }, "uncruise adventures": { name: "UnCruise Adventures" }, "adventures by disney": { name: "Adventures by Disney" }, "disneyland": { name: "Disneyland" }, "disneyworld": { name: "DisneyWorld" }, "walt disney world": { name: "DisneyWorld" }, "aulani a disney resort & spa": { name: "Aulani" }, "aulani": { name: "Aulani" }, "sandals": { name: "Sandals" }, "beaches": { name: "Beaches Resorts" }, "beaches resorts": { name: "Beaches Resorts" }, "breathless": { name: "Breathless Resorts" }, "breathless resorts": { name: "Breathless Resorts" }, "club med": { name: "Club Med" }, "el dorado spa resorts & hotels": { name: "El Dorado Spa Resorts" }, "el dorado spa resorts": { name: "El Dorado Spa Resorts" }, "dreams": { name: "Dreams Resorts" }, "dreams resorts": { name: "Dreams Resorts" }, "excellence resorts": { name: "Excellence Resorts" }, "hard rock hotels": { name: "Hard Rock Hotels" }, "hard rock hotel & casino": { name: "Hard Rock Hotels" }, "iberostar hotels & resorts": { name: "Iberostar Hotels & Resorts" }, "iberostar beachfront resorts": { name: "Iberostar Hotels & Resorts" }, "karisma hotels & resorts": { name: "Karisma Hotels & Resorts" }, "outrigger hotels & resorts": { name: "Outrigger Hotels & Resorts" }, "palace resorts": { name: "Palace Resorts" }, "riu hotels & resorts": { name: "RIU Hotels & Resorts" }, "secrets": { name: "Secrets Resorts" }, "secrets resorts": { name: "Secrets Resorts" }, "american airline vacations": { name: "American Airlines Vacations" }, "american airlines vacations": { name: "American Airlines Vacations" }, "delta vacations": { name: "Delta Vacations" }, "southwest vacations": { name: "Southwest Vacations" }, "united vacations": { name: "United Vacations" }, "villas of distinction": { name: "Villas of Distinction" }, "zoetry wellness & spa resorts": { name: "ZoÃ«try Wellness & Spa Resorts" }, "atlantis paradise island bahamas": { name: "Atlantis Paradise Island" }, "atlantis": { name: "Atlantis Paradise Island" }, "atlantis paradise island": { name: "Atlantis Paradise Island" }, "great safaris": { name: "Great Safaris" }, "african travel": { name: "African Travel" }, "abercrombie & kent": { name: "Abercrombie & Kent" }, "g adventures": { name: "G Adventures" }, "globus journeys": { name: "Globus Journeys" }, "globus": { name: "Globus Journeys" }, "trafalgar": { name: "Trafalgar" }, "bluesky tours": { name: "BlueSky Tours" }, "cie tours": { name: "CIE Tours" }, "collette": { name: "Collette" }, "shore excursions group": { name: "Shore Excursions Group" }, "toursalescom": { name: "TourSales.com" }, "viator": { name: "Viator" }, "project expedition": { name: "Project Expedition" }, "rocky mountaineer": { name: "Rocky Mountaineer" }, "viking river cruises": { name: "Viking River Cruises" }, "disney cruises": {name: "Disney Cruises"}
        };


        function normalizeSupplier(name) { return name?.toLowerCase().trim().replace(/&/g, '&').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()']/g,"").replace(/\s+/g,' ').trim() || ''; }
        function formatDisplayName(key) { return key ? key.split(' ').map(w => w ? w.charAt(0).toUpperCase() + w.slice(1) : '').join(' ') : "Unknown"; }
        function getDisplayName(key) { 
            const normalized = normalizeSupplier(key);
            return SUPPLIER_INFO[normalized]?.name || formatDisplayName(key); 
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const lowerDateString = String(dateString).toLowerCase().trim(); 

            if (lowerDateString === 'call for details') return 'Call for details';
            if (lowerDateString === 'contact us') return 'Contact Us';
            if (lowerDateString === 'ongoing') return 'Ongoing';
            
            try { 
                const d = new Date(dateString); 
                if (isNaN(d.getTime()) || d.getFullYear() > 2050 || d.getFullYear() < 1990) {
                    return ''; 
                }
                return `Ends ${d.getMonth() + 1}/${d.getDate()}`; 
            }
            catch (e) { 
                return ''; 
            }
        }

        function parseDeals(rawInput) {
            const parsed = []; let dealObjects = [];
            try { dealObjects = JSON.parse(rawInput); if (!Array.isArray(dealObjects)) throw new Error("Not JSON array."); }
            catch (e) { alert(`Invalid JSON input for Deal Lister:\n${e.message}`); return []; }

            dealObjects.forEach((deal, index) => {
                try {
                    if (typeof deal !== 'object' || deal === null) return;
                    const { status, shopOverline, title, shopListing, dealCategory, expiryDate: expiryDateStr } = deal;
                    if (!shopOverline || !title || !shopListing || !status) return;
                    if (status !== "live") return;

                    const supplierKey = shopOverline; 
                    const displayName = getDisplayName(supplierKey);
                    if (displayName === "Unknown" || !displayName) return; 

                    const categories = dealCategory || [];
                    const isExclusive = categories.includes(39542);
                    const formattedExpiry = formatDate(expiryDateStr); 
                    let expiryDateObj = null;
                    if (expiryDateStr && !['call for details', 'contact us', 'ongoing'].includes(String(expiryDateStr).toLowerCase().trim())) {
                        const tempDate = new Date(expiryDateStr);
                        if (!isNaN(tempDate.getTime())) {
                            expiryDateObj = tempDate;
                        }
                    }

                    parsed.push({
                        displayName: displayName, 
                        title: title,
                        description: shopListing,
                        exclusive: isExclusive,
                        formattedExpiryDate: formattedExpiry, 
                        expiryDateObject: expiryDateObj, 
                        id: crypto.randomUUID() 
                    });
                } catch (error) { console.error(`Error processing deal object at index ${index}:`, error, deal); }
            });
            return parsed;
        }

        function sortDisplayedDeals() { 
            const fallbackDate = new Date('2099-12-31'); 
            const veryOldDate = new Date('1970-01-01'); 

            displayedDeals.sort((a, b) => {
                if (currentSort === 'supplier') {
                    const nameCompare = a.displayName.localeCompare(b.displayName);
                    if (nameCompare !== 0) return nameCompare;
                    const dateA = a.expiryDateObject || fallbackDate; 
                    const dateB = b.expiryDateObject || fallbackDate;
                    return dateA.getTime() - dateB.getTime();
                } else if (currentSort === 'expiry') {
                    const dateA = a.expiryDateObject || fallbackDate; 
                    const dateB = b.expiryDateObject || fallbackDate;
                    const dateCompare = dateA.getTime() - dateB.getTime();
                    if (dateCompare !== 0) return dateCompare;
                    return a.displayName.localeCompare(b.displayName); 
                } else if (currentSort === 'exclusive') {
                    const exclusiveCompare = b.exclusive - a.exclusive; 
                    if (exclusiveCompare !== 0) return exclusiveCompare;
                    const dateA = a.expiryDateObject || fallbackDate; 
                    const dateB = b.expiryDateObject || fallbackDate;
                    return dateA.getTime() - dateB.getTime();
                }
                return 0;
            });
        }
        
        function renderDealList() {
            const listElement = document.getElementById('deal-list');
            listElement.innerHTML = '';

            if (selectedDealsForCopy.length === 0) {
                const placeholderText = allParsedDeals.length > 0 ?
                    "No deals match the current filters, or all have been removed." :
                    "Paste JSON and click \"Show Deals\", or no valid deals were found in the input.";
                listElement.innerHTML = `<li class="placeholder">${placeholderText}</li>`;
                return;
            }
            
            const dealsToRender = [...selectedDealsForCopy]; 
            const fallbackDate = new Date('2099-12-31');
            dealsToRender.sort((a, b) => {
                if (currentSort === 'supplier') {
                    const nameCompare = a.displayName.localeCompare(b.displayName);
                    if (nameCompare !== 0) return nameCompare;
                    return (a.expiryDateObject || fallbackDate).getTime() - (b.expiryDateObject || fallbackDate).getTime();
                } else if (currentSort === 'expiry') {
                    const dateCompare = (a.expiryDateObject || fallbackDate).getTime() - (b.expiryDateObject || fallbackDate).getTime();
                    if (dateCompare !== 0) return dateCompare;
                    return a.displayName.localeCompare(b.displayName);
                } else if (currentSort === 'exclusive') {
                    const exclusiveCompare = b.exclusive - a.exclusive;
                    if (exclusiveCompare !== 0) return exclusiveCompare;
                    return (a.expiryDateObject || fallbackDate).getTime() - (b.expiryDateObject || fallbackDate).getTime();
                }
                return 0;
            });


            dealsToRender.forEach(deal => {
                const li = document.createElement('li');
                li.className = 'deal-item';
                const expiryPillHtml = deal.formattedExpiryDate ? `<span class="expiry-pill">${deal.formattedExpiryDate}</span>` : '';
                const exclusiveIndicator = deal.exclusive ? '<span class="exclusive-star" title="Exclusive Deal">â˜…</span>' : '';
                li.innerHTML = `
                    <div class="indicator">${exclusiveIndicator}</div>
                    <div class="supplier">${deal.displayName}</div>
                    <div class="title-line">
                        <span class="title">${deal.title}</span>
                        ${expiryPillHtml}
                    </div>
                    <div class="description">${deal.description}</div>
                    <button class="remove-deal-btn" data-deal-id="${deal.id}" title="Remove this deal from selection">âœ–</button>
                `;
                listElement.appendChild(li);
            });
        }
        
        function updateDealListerFilterUIStates() {
            document.querySelectorAll('#supplier-filters button').forEach(btn => {
                btn.classList.toggle('active', !isRotatorFilterActive && btn.dataset.supplier === (activeSupplierFilter || 'ALL'));
                btn.disabled = isRotatorFilterActive; 
            });

            const exclusiveBtn = document.getElementById('exclusive-toggle-btn');
            exclusiveBtn.classList.toggle('active', showExclusivesOnly);
            exclusiveBtn.textContent = showExclusivesOnly ? 'Showing Only Exclusives' : 'Show Only Exclusives';
            
            document.querySelectorAll('.sort-options button').forEach(b => b.classList.remove('active'));
            document.getElementById(`sort-${currentSort}`)?.classList.add('active');

            const rotatorStatusDiv = document.getElementById('rotator-filter-status-container');
            if (isRotatorFilterActive && rotatorComputedSuppliers.length > 0) {
                rotatorStatusDiv.style.display = 'block';
                document.getElementById('rotator-filter-names').textContent = rotatorComputedSuppliers.join(', ');
            } else {
                rotatorStatusDiv.style.display = 'none';
            }
        }
        
        function updateAndRenderDeals() {
            let tempDeals = [...allParsedDeals];

            if (isRotatorFilterActive && rotatorComputedSuppliers.length > 0) {
                tempDeals = tempDeals.filter(d => rotatorComputedSuppliers.includes(d.displayName));
            } else {
                if (activeSupplierFilter) {
                    tempDeals = tempDeals.filter(d => d.displayName === activeSupplierFilter);
                }
            }

            if (showExclusivesOnly) {
                tempDeals = tempDeals.filter(d => d.exclusive);
            }

            displayedDeals = [...tempDeals]; 
            sortDisplayedDeals(); 
            
            selectedDealsForCopy = [...displayedDeals]; 

            renderDealList(); 
            updateDealListerFilterUIStates();
        }

        function renderSupplierFilters() {
            const container = document.getElementById('supplier-filters');
            container.innerHTML = '';
            const uniqueSuppliers = [...new Set(allParsedDeals.map(d => d.displayName))].sort();
            
            const allBtn = document.createElement('button');
            allBtn.textContent = 'All Suppliers';
            allBtn.dataset.supplier = 'ALL';
            allBtn.onclick = () => setSupplierFilter(null);
            container.appendChild(allBtn);

            uniqueSuppliers.forEach(supplierName => {
                const btn = document.createElement('button');
                btn.textContent = supplierName;
                btn.dataset.supplier = supplierName;
                btn.onclick = () => setSupplierFilter(supplierName);
                container.appendChild(btn);
            });
        }

        function activateRotatorFilterInDealLister(supplierNames) {
            isRotatorFilterActive = true;
        }

        function clearRotatorFilterLogic() {
            isRotatorFilterActive = false;
            rotatorComputedSuppliers = []; 
        }
        
        window.clearRotatorFilterAndRefreshDeals = function() {
            clearRotatorFilterLogic();
            updateAndRenderDeals(); 
        }

        window.handleRemoveDeal = function(dealId) {
            selectedDealsForCopy = selectedDealsForCopy.filter(d => d.id !== dealId);
            renderDealList(); 
        }
        
        window.setSupplierFilter = function(supplierName) {
            if (isRotatorFilterActive) return; 
            activeSupplierFilter = supplierName;
            updateAndRenderDeals();
        }
        window.toggleExclusiveFilter = function() {
            showExclusivesOnly = !showExclusivesOnly;
            updateAndRenderDeals();
        }
        window.setSort = function(sortType) {
            if (currentSort !== sortType) {
                currentSort = sortType;
                updateAndRenderDeals(); 
            }
        }
        window.processJsonInput = function() {
            const rawInput = document.getElementById('deals-input').value;
            if (!rawInput.trim()) { alert("Paste JSON for Deal Lister first."); return; }
            allParsedDeals = parseDeals(rawInput);
            const filtersContainer = document.getElementById('filters-and-sorts-container');
            if (allParsedDeals.length > 0) {
                filtersContainer.style.display = 'block';
                renderSupplierFilters(); 
            } else {
                filtersContainer.style.display = 'none';
                document.getElementById('supplier-filters').innerHTML = '';
            }
            updateAndRenderDeals();
        }
        window.clearAllDealLister = function() { 
             allParsedDeals = []; displayedDeals = []; selectedDealsForCopy = [];
             document.getElementById('deals-input').value = '';
             document.getElementById('filters-and-sorts-container').style.display = 'none';
             document.getElementById('supplier-filters').innerHTML = '';
             activeSupplierFilter = null; showExclusivesOnly = false; currentSort = 'supplier';
             clearRotatorFilterLogic(); 
             updateAndRenderDeals(); 
        }

        window.copySelectedDealsToClipboard = function() {
            if (selectedDealsForCopy.length === 0) {
                alert("No deals currently selected/visible to copy.");
                return;
            }

            const dealsBySupplier = selectedDealsForCopy.reduce((acc, deal) => {
                if (!acc[deal.displayName]) {
                    acc[deal.displayName] = [];
                }
                acc[deal.displayName].push(deal);
                return acc;
            }, {});

            const sortedSupplierNames = Object.keys(dealsBySupplier).sort((a, b) => a.localeCompare(b));

            let outputText = "";
            const fallbackDate = new Date('2099-12-31'); 

            sortedSupplierNames.forEach((supplierName, index) => {
                if (index > 0) {
                    outputText += "\n"; 
                }
                outputText += supplierName + "\n";

                let supplierDeals = dealsBySupplier[supplierName];

                supplierDeals.sort((a, b) => {
                    if (a.exclusive !== b.exclusive) {
                        return b.exclusive - a.exclusive; 
                    }
                    const dateA = a.expiryDateObject || fallbackDate;
                    const dateB = b.expiryDateObject || fallbackDate;
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateA.getTime() - dateB.getTime(); 
                    }
                    return a.title.localeCompare(b.title); 
                });

                supplierDeals.forEach(deal => {
                    let dealTitleForCopy = deal.title;
                    let prefix = "";

                    if (deal.exclusive) {
                        // Check if title already starts with "EXCLUSIVE:" (case-insensitive)
                        // and add the prefix only if it's not already there.
                        if (!deal.title.toLowerCase().startsWith("exclusive:")) {
                             prefix = "EXCLUSIVE: ";
                        }
                    }
                    
                    let dealLine = prefix + dealTitleForCopy;

                    if (deal.formattedExpiryDate) { 
                        dealLine += " â€“ " + deal.formattedExpiryDate;
                    }
                    outputText += dealLine + "\n";
                });
            });

            navigator.clipboard.writeText(outputText.trim())
                .then(() => alert(`${selectedDealsForCopy.length} deal(s) formatted and copied to clipboard!`))
                .catch(err => alert('Failed to copy deals: ' + err));
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            populateRotatorSelectors();
            computeRotatorBtn.addEventListener('click', computeRotatorResults);
            updateDealListerFilterUIStates(); 
            document.getElementById('deal-list').addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-deal-btn')) {
                    const dealId = event.target.dataset.dealId;
                    window.handleRemoveDeal(dealId);
                }
            });
        });
    })();
    </script>
</body>
</html>